<!DOCTYPE html>
<html lang="zh" data-theme="akane">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÁßëÂ≠¶ËÆ°ÁÆóÂô®</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mathjs@12.4.2/lib/browser/math.min.js"></script>

    <style>
        /* --- 1. MD3 Âü∫Á°Ä‰∏é‰∏ªÈ¢òÁ≥ªÁªü --- */
        :root {
            /* ÈªòËÆ§‰∏ªÈ¢ò: Ëåú (Akane) */
            --md-sys-color-primary: #B22C46;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-secondary: #D96B7E;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-tertiary: #A9A9A9;
            --md-sys-color-on-tertiary: #000000;
            --md-sys-color-surface: #3A0E17;
            --md-sys-color-on-surface: #EAEAEA;
            --md-sys-color-surface-variant: #5C1F2A;
            --md-sys-color-on-surface-variant: #CCCCCC;
            --md-sys-color-background: #280a10;
            --md-sys-color-on-background: #FFFFFF;
            --md-sys-color-outline: #8C4753;

            --font-family: 'Roboto', 'Noto Sans SC', sans-serif;
            --transition-speed-fast: 0.2s;
            --transition-speed-normal: 0.3s;
            --border-radius-lg: 1.5rem; /* 24px */
            --border-radius-md: 1rem;   /* 16px */
        }

        /* ‰∏ªÈ¢òÂÆö‰πâ */
        [data-theme="sumi"] { --md-sys-color-primary: #4A4A4A; --md-sys-color-on-primary: #FFFFFF; --md-sys-color-secondary: #848484; --md-sys-color-on-secondary: #FFFFFF; --md-sys-color-surface: #1C1C1C; --md-sys-color-background: #121212; --md-sys-color-surface-variant: #2C2C2C; --md-sys-color-outline: #5A5A5A; }
        [data-theme="sakura"] { --md-sys-color-primary: #FECEDC; --md-sys-color-on-primary: #3E2E34; --md-sys-color-secondary: #F5A8BE; --md-sys-color-on-secondary: #3E2E34; --md-sys-color-surface: #3E2E34; --md-sys-color-background: #2b2024; --md-sys-color-surface-variant: #58444A; --md-sys-color-outline: #a58992; }
        [data-theme="matcha"] { --md-sys-color-primary: #96B1A0; --md-sys-color-on-primary: #2E3832; --md-sys-color-secondary: #C8D5CB; --md-sys-color-on-secondary: #2E3832; --md-sys-color-surface: #2E3832; --md-sys-color-background: #202723; --md-sys-color-surface-variant: #44544A; --md-sys-color-outline: #7a8f82; }
        [data-theme="ai"] { --md-sys-color-primary: #264D70; --md-sys-color-on-primary: #FFFFFF; --md-sys-color-secondary: #5A82A6; --md-sys-color-on-secondary: #FFFFFF; --md-sys-color-surface: #102231; --md-sys-color-background: #0a1620; --md-sys-color-surface-variant: #1c3850; --md-sys-color-outline: #42698a; }
        [data-theme="yamabuki"] { --md-sys-color-primary: #FCA500; --md-sys-color-on-primary: #3D2D00; --md-sys-color-secondary: #FFC14D; --md-sys-color-on-secondary: #3D2D00; --md-sys-color-surface: #3D2D00; --md-sys-color-background: #2a2000; --md-sys-color-surface-variant: #574100; --md-sys-color-outline: #b17a00; }
        [data-theme="fuji"] { --md-sys-color-primary: #A290C4; --md-sys-color-on-primary: #2C2635; --md-sys-color-secondary: #C5B8DE; --md-sys-color-on-secondary: #2C2635; --md-sys-color-surface: #322C3E; --md-sys-color-background: #231f2a; --md-sys-color-surface-variant: #4a4258; --md-sys-color-outline: #80709f; }
        [data-theme="akane"] { --md-sys-color-primary: #B22C46; --md-sys-color-on-primary: #FFFFFF; --md-sys-color-secondary: #D96B7E; --md-sys-color-on-secondary: #FFFFFF; --md-sys-color-surface: #3A0E17; --md-sys-color-background: #280a10; --md-sys-color-surface-variant: #5C1F2A; --md-sys-color-outline: #8C4753; }
        [data-theme="wakatake"] { --md-sys-color-primary: #7BC5A3; --md-sys-color-on-primary: #243C31; --md-sys-color-secondary: #A8DBC1; --md-sys-color-on-secondary: #243C31; --md-sys-color-surface: #243C31; --md-sys-color-background: #192a22; --md-sys-color-surface-variant: #3a5c4a; --md-sys-color-outline: #629e82; }
        [data-theme="kin"] { --md-sys-color-primary: #D4AF37; --md-sys-color-on-primary: #413510; --md-sys-color-secondary: #EACD6F; --md-sys-color-on-secondary: #413510; --md-sys-color-surface: #413510; --md-sys-color-background: #2d240b; --md-sys-color-surface-variant: #5d4b17; --md-sys-color-outline: #a4872b; }
        [data-theme="gin"] { --md-sys-color-primary: #C0C0C0; --md-sys-color-on-primary: #3C3C3C; --md-sys-color-secondary: #E0E0E0; --md-sys-color-on-secondary: #3C3C3C; --md-sys-color-surface: #3C3C3C; --md-sys-color-background: #292929; --md-sys-color-surface-variant: #565656; --md-sys-color-outline: #989898; }

        /* --- 2. Âü∫Á°ÄÂ∏ÉÂ±Ä‰∏éÊ†∑Âºè --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            transition: background-color var(--transition-speed-normal) ease;
        }
        .calculator {
            width: 100%;
            max-width: 380px;
            background-color: var(--md-sys-color-surface);
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 8px 32px -8px rgba(0,0,0,0.3);
            transition: background-color var(--transition-speed-normal) ease;
        }
        
        /* --- 3. È°∂ÈÉ®Ê†è --- */
        .calculator-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.5rem 1.5rem 0.5rem; color: var(--md-sys-color-on-surface); }
        .header-title { font-size: 1.2rem; font-weight: 700; }
        .header-icons { display: flex; align-items: center; gap: 1rem; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--md-sys-color-on-surface-variant); padding: 0.25rem; transition: color var(--transition-speed-fast) ease; line-height: 0; }
        .icon-btn:hover { color: var(--md-sys-color-primary); }
        .icon-btn svg { width: 24px; height: 24px; }
        
        /* --- 4. ÊòæÁ§∫Â±è --- */
        .display { background-color: rgba(0,0,0,0.2); border-radius: var(--border-radius-md); padding: 1.5rem 1rem; text-align: right; margin-bottom: 1rem; min-height: 120px; display: flex; flex-direction: column; justify-content: flex-end; }
        #display-expression { font-size: 1.2rem; color: var(--md-sys-color-on-surface-variant); word-break: break-all; min-height: 1.5rem; }
        #display-input { font-size: 3rem; font-weight: 500; color: var(--md-sys-color-on-surface); word-break: break-all; transition: color 0.4s ease, transform 0.4s ease; }
        @keyframes highlight-result { 0% { color: var(--md-sys-color-primary); transform: scale(1.05); } 100% { color: var(--md-sys-color-on-surface); transform: scale(1); } }
        .highlight { animation: highlight-result 0.4s ease-out; }

        /* --- 5. ÊåâÈíÆ --- */
        .buttons-grid { display: grid; gap: 0.75rem; grid-template-columns: repeat(5, 1fr); }
        .btn { height: 56px; border-radius: var(--border-radius-md); border: none; cursor: pointer; transition: all var(--transition-speed-fast) ease; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.25rem; line-height: 1.2; }
        .btn:active { transform: scale(0.95); }
        .btn-symbol { font-size: 1.5rem; font-weight: 500; }
        .btn-label { font-size: 0.7rem; color: var(--md-sys-color-on-surface-variant); }
        .btn.btn-number .btn-symbol, .btn.btn-operator .btn-symbol, .btn.btn-tertiary .btn-symbol { font-size: 1.8rem; }
        .btn.btn-secondary .btn-label { color: var(--md-sys-color-on-secondary); opacity: 0.8; }
        .btn.btn-operator .btn-label { color: var(--md-sys-color-on-primary); opacity: 0.8; }
        .btn.btn-number { background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); }
        .btn.btn-operator { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn.btn-tertiary { background-color: var(--md-sys-color-tertiary); color: var(--md-sys-color-on-tertiary); }
        .btn.btn-secondary { background-color: var(--md-sys-color-secondary); color: var(--md-sys-color-on-secondary); }
        .btn.span-2 { grid-column: span 2; }
        #solve-steps-btn .btn-symbol { font-size: 1.2rem; font-weight: 700; }

        /* --- 6. Ê®°ÊÄÅÊ°Ü --- */
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed-normal) ease; z-index: 1000; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--md-sys-color-surface); padding: 2rem; border-radius: var(--border-radius-lg); max-width: 500px; width: 100%; position: relative; transform: scale(0.95); opacity: 0; transition: all var(--transition-speed-normal) cubic-bezier(0.4, 0, 0.2, 1); }
        .modal.visible .modal-content { transform: scale(1); opacity: 1; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--md-sys-color-on-surface-variant); font-size: 1.5rem; cursor: pointer; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--md-sys-color-primary); margin-bottom: 1.5rem; }
        .modal-body { max-height: 60vh; overflow-y: auto; line-height: 1.6; color: var(--md-sys-color-on-surface); }
        .ai-menu, .life-calc-menu { display: grid; gap: 1rem; grid-template-columns: 1fr; }
        .ai-menu-btn, .life-calc-btn { padding: 1rem; font-size: 1rem; font-weight: 700; border: none; border-radius: var(--border-radius-md); background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); cursor: pointer; transition: all var(--transition-speed-fast) ease; text-align: left; display: flex; align-items: center; gap: 0.75rem;}
        .ai-menu-btn:hover, .life-calc-btn:hover { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        #history-modal-body { display: flex; flex-direction: column-reverse; gap: 1rem; padding-right: 0.5rem; }
        #history-modal-body::-webkit-scrollbar { width: 4px; }
        #history-modal-body::-webkit-scrollbar-track { background: transparent; }
        #history-modal-body::-webkit-scrollbar-thumb { background: var(--md-sys-color-outline); border-radius: 2px; }
        .history-item .expression { font-size: 0.9rem; color: var(--md-sys-color-on-surface-variant); word-break: break-all; }
        .history-item .result { font-size: 1.2rem; font-weight: 500; color: var(--md-sys-color-on-surface); }
        #word-problem-textarea { width: 100%; min-height: 100px; background-color: var(--md-sys-color-surface-variant); border: 1px solid var(--md-sys-color-outline); border-radius: var(--border-radius-md); padding: 0.75rem; color: var(--md-sys-color-on-surface); font-family: inherit; margin-bottom: 1rem; }
        
        /* --- 7. ËÆæÁΩÆ‰∏éÁîüÊ¥ªËÆ°ÁÆóÂô®Ê†∑Âºè --- */
        .settings-section, .calc-section { margin-bottom: 2rem; }
        .settings-section:last-child, .calc-section:last-child { margin-bottom: 0; }
        .settings-title, .calc-title { font-size: 1rem; font-weight: 700; color: var(--md-sys-color-on-surface-variant); margin-bottom: 1rem; border-bottom: 1px solid var(--md-sys-color-outline); padding-bottom: 0.5rem; }
        #theme-palette-container, .language-options { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }
        .theme-item { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; cursor: pointer; }
        .theme-color-circle { width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; transition: all var(--transition-speed-fast) ease; }
        .theme-item.active .theme-color-circle { border-color: var(--md-sys-color-primary); transform: scale(1.1); }
        .theme-name { font-size: 0.8rem; color: var(--md-sys-color-on-surface-variant); }
        .lang-btn { background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); border: 2px solid transparent; border-radius: var(--border-radius-md); padding: 0.75rem; cursor: pointer; transition: all var(--transition-speed-fast) ease; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; }
        .lang-btn:hover { border-color: var(--md-sys-color-outline); }
        .lang-btn.active { border-color: var(--md-sys-color-primary); background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .lang-btn .flag { font-size: 1.5rem; line-height: 1; }
        .lang-btn .name { font-size: 0.8rem; font-weight: 500; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; background-color: var(--md-sys-color-surface-variant); border: 1px solid var(--md-sys-color-outline); border-radius: var(--border-radius-md); color: var(--md-sys-color-on-surface); font-family: inherit; font-size: 1rem; }
        .calc-result { margin-top: 1.5rem; padding: 1rem; background-color: rgba(0,0,0,0.2); border-radius: var(--border-radius-md); text-align: center; }
        .calc-result .label { font-size: 0.9rem; color: var(--md-sys-color-on-surface-variant); }
        .calc-result .value { font-size: 1.8rem; font-weight: 700; color: var(--md-sys-color-primary); }
        .primary-btn { width: 100%; padding: 0.75rem; background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border: none; border-radius: var(--border-radius-md); cursor: pointer; font-weight: 700; font-size: 1rem; }
        
        /* --- 8. Ê±áÁéáÊç¢ÁÆóÂô®Êñ∞Ê†∑Âºè --- */
        .exchange-rate-ui { display: flex; flex-direction: column; gap: 1.5rem; }
        .currency-selection { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .currency-box { flex: 1; text-align: center; }
        .currency-box .label { margin-bottom: 0.75rem; font-weight: 500; }
        .currency-button { width: 100%; padding: 0.75rem; border: 2px solid var(--md-sys-color-outline); border-radius: var(--border-radius-md); background: none; color: var(--md-sys-color-on-surface); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1rem; }
        .currency-button:hover { background-color: var(--md-sys-color-surface-variant); }
        .currency-button .flag { font-size: 1.5rem; }
        #swap-currency-btn { padding: 0.75rem; line-height: 0; background-color: var(--md-sys-color-tertiary); color: var(--md-sys-color-on-tertiary); border: none; border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
        .currency-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; margin-top: 1rem; }
        .currency-grid-btn { padding: 0.5rem; background-color: var(--md-sys-color-surface-variant); border: 2px solid transparent; border-radius: var(--border-radius-md); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
        .currency-grid-btn:hover { border-color: var(--md-sys-color-outline); }
        .currency-grid-btn.selected { border-color: var(--md-sys-color-primary); }
        .currency-grid-btn .flag { font-size: 1.2rem; }
        .currency-grid-btn .code { font-size: 0.8rem; font-weight: 500; }
    </style>
</head>
<body>

    <div class="calculator" id="calculator">
        <!-- È°∂ÈÉ®Ê†è -->
        <div class="calculator-header">
            <h1 class="header-title" data-i18n="headerTitle">Êô∫ËÉΩÁßëÂ≠¶ËÆ°ÁÆóÂô®</h1>
            <div class="header-icons">
                <button class="icon-btn" id="ai-btn" data-i18n-title="aiBtnTitle" title="AI ÂäüËÉΩ">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.51a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0Zm4.5-5.25a.75.75 0 0 0-1.5 0v2.51a.75.75 0 0 0 1.5 0V6.75ZM18.682 6.318a.75.75 0 0 0-1.06-1.06l-1.768 1.768a.75.75 0 1 0 1.06 1.06l1.768-1.768ZM6.382 18.618a.75.75 0 0 0 1.06 1.06l1.768-1.768a.75.75 0 0 0-1.06-1.06l-1.768 1.768ZM12 21.75a.75.75 0 0 0 0-1.5v-2.51a.75.75 0 0 0-1.5 0v2.51a.75.75 0 0 0 1.5 0ZM3.515 13.5a.75.75 0 0 0-1.5 0H.75a.75.75 0 0 0 0 1.5h2.265a.75.75 0 0 0 1.5 0h-2.265ZM23.25 12.75a.75.75 0 0 0 0-1.5h-2.265a.75.75 0 0 0-1.5 0h2.265a.75.75 0 0 0 1.5 0ZM6.382 5.382a.75.75 0 0 0-1.06 1.06L7.09 8.21a.75.75 0 0 0 1.06-1.06L6.382 5.382ZM18.682 17.682a.75.75 0 0 0-1.06 1.06l1.768 1.768a.75.75 0 0 0 1.06-1.06l-1.768-1.768Z"/></svg>
                </button>
                <button class="icon-btn" id="settings-btn" data-i18n-title="settingsBtnTitle" title="ËÆæÁΩÆ">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M11.078 2.25c-.917 0-1.699.663-1.85 1.567L9.05 5.85c-.09.55-.552.95-1.11.95H4.847c-.917 0-1.699.663-1.85 1.567L2.828 9.48c-.09.55.242 1.05.748 1.285l2.108.843c.441.176.748.578.748 1.05v1.82c0 .917.663 1.699 1.567 1.85l2.123.17c.55.04.95.502.95 1.06v3.103c0 .917.663 1.699 1.567 1.85L12.922 21.15c.55.09.95-.242 1.05-.748l.17-2.123c.04-.55.502-.95 1.06-.95h3.103c.917 0 1.699-.663 1.85-1.567l.17-2.123c.09-.55-.242-1.05-.748-1.285l-2.108-.843c-.441-.176-.748-.578-.748-1.05v-1.82c0-.917-.663-1.699-1.567-1.85l-2.123-.17c-.55-.04-.95-.502-.95-1.06V3.817c0-.917-.663-1.699-1.567-1.85L12.922 1.8c-.55-.09-.95.242-1.05.748l-.17 2.123c-.04.55-.502.95-1.06.95H7.547c-.917 0-1.699.663-1.85 1.567L5.528 9.48c-.09.55.242 1.05.748 1.285l2.108.843c.441.176.748.578.748 1.05v1.82c0 .917.663 1.699 1.567 1.85l2.123.17c.55.04.95.502.95 1.06v3.103c0 .917.663 1.699 1.567 1.85l.008.001a1.5 1.5 0 0 0 1.842-1.569l-.17-2.123c-.04-.55.242-1.05.748-1.285l2.108-.843c.441-.176.748-.578.748-1.05v-1.82c0-.917-.663-1.699-1.567-1.85l-2.123-.17c-.55-.04-.95-.502-.95-1.06V3.817c0-.917-.663-1.699-1.567-1.85L12.922 1.8A1.5 1.5 0 0 0 11.078 2.25ZM12 15.75a3.75 3.75 0 1 1 0-7.5 3.75 3.75 0 0 1 0 7.5Z" clip-rule="evenodd" /></svg>
                </button>
                <button class="icon-btn" id="history-btn" data-i18n-title="historyBtnTitle" title="ÂéÜÂè≤ËÆ∞ÂΩï">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>

        <!-- ÊòæÁ§∫Â±è -->
        <div class="display">
            <div id="display-expression"></div>
            <div id="display-input">0</div>
        </div>
        
        <!-- ÊåâÈíÆÁΩëÊ†º -->
        <div class="buttons-grid">
            <button class="btn btn-secondary" data-value="sin("><span class="btn-symbol">sin</span><span class="btn-label" data-i18n="sinLabel">Ê≠£Âº¶</span></button>
            <button class="btn btn-secondary" data-value="cos("><span class="btn-symbol">cos</span><span class="btn-label" data-i18n="cosLabel">‰ΩôÂº¶</span></button>
            <button class="btn btn-secondary" data-value="tan("><span class="btn-symbol">tan</span><span class="btn-label" data-i18n="tanLabel">Ê≠£Âàá</span></button>
            <button class="btn btn-secondary" data-value="log("><span class="btn-symbol">log</span><span class="btn-label" data-i18n="logLabel">ÂØπÊï∞</span></button>
            <button class="btn btn-secondary" data-value="ln("><span class="btn-symbol">ln</span><span class="btn-label" data-i18n="lnLabel">Ëá™ÁÑ∂ÂØπÊï∞</span></button>

            <button class="btn btn-secondary" data-value="("><span class="btn-symbol">(</span></button>
            <button class="btn btn-secondary" data-value=")"><span class="btn-symbol">)</span></button>
            <button class="btn btn-secondary" data-value="^"><span class="btn-symbol">x ∏</span><span class="btn-label" data-i18n="powerLabel">‰πòÊñπ</span></button>
            <button class="btn btn-secondary" data-value="sqrt("><span class="btn-symbol">‚àö</span><span class="btn-label" data-i18n="sqrtLabel">Âπ≥ÊñπÊ†π</span></button>
            <button class="btn btn-secondary" data-value="!"><span class="btn-symbol">x!</span><span class="btn-label" data-i18n="factLabel">Èò∂‰πò</span></button>

            <button class="btn btn-tertiary" data-action="clear"><span class="btn-symbol">C</span></button>
            <button class="btn btn-tertiary" data-action="backspace"><span class="btn-symbol">‚å´</span></button>
            <button class="btn btn-tertiary" data-value="%"><span class="btn-symbol">%</span></button>
            <button class="btn btn-secondary" data-value="PI"><span class="btn-symbol">œÄ</span><span class="btn-label" data-i18n="piLabel">ÂúÜÂë®Áéá</span></button>
            <button class="btn btn-secondary" data-value="E"><span class="btn-symbol">e</span><span class="btn-label" data-i18n="eLabel">Ëá™ÁÑ∂Â∏∏Êï∞</span></button>
            
            <button class="btn btn-number" data-value="7"><span class="btn-symbol">7</span></button>
            <button class="btn btn-number" data-value="8"><span class="btn-symbol">8</span></button>
            <button class="btn btn-number" data-value="9"><span class="btn-symbol">9</span></button>
            <button class="btn btn-operator" data-value="/"><span class="btn-symbol">√∑</span></button>
            <button class="btn btn-operator" data-value="*"><span class="btn-symbol">√ó</span></button>

            <button class="btn btn-number" data-value="4"><span class="btn-symbol">4</span></button>
            <button class="btn btn-number" data-value="5"><span class="btn-symbol">5</span></button>
            <button class="btn btn-number" data-value="6"><span class="btn-symbol">6</span></button>
            <button class="btn btn-operator" data-value="-"><span class="btn-symbol">-</span></button>
            <button class="btn btn-operator" data-value="+"><span class="btn-symbol">+</span></button>

            <button class="btn btn-number" data-value="1"><span class="btn-symbol">1</span></button>
            <button class="btn btn-number" data-value="2"><span class="btn-symbol">2</span></button>
            <button class="btn btn-number" data-value="3"><span class="btn-symbol">3</span></button>
            <button class="btn btn-operator span-2" data-action="equals"><span class="btn-symbol">=</span></button>

            <button class="btn btn-number span-2" data-value="0"><span class="btn-symbol">0</span></button>
            <button class="btn btn-number" data-value="."><span class="btn-symbol">.</span></button>
            <button class="btn btn-operator span-2" id="solve-steps-btn" data-ai-action="solve"><span class="btn-symbol" data-i18n="solveSteps">Ëß£È¢òÊÄùË∑Ø</span></button>
        </div>
    </div>

    <!-- ÈÄöÁî®Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3 class="modal-title" id="modal-title"></h3>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script type="module">
        // --- 1. Áä∂ÊÄÅ„ÄÅÂ∏∏Èáè‰∏éÂõΩÈôÖÂåñÊñáÊú¨ ---
        const state = {
            expression: '',
            history: [],
            justCalculated: false,
            currentLanguage: 'zh',
            exchange: { from: 'CNY', to: 'USD' },
        };

        const THEMES = [
            { id: 'sumi', color: '#4A4A4A', name: 'Â¢®' }, { id: 'sakura', color: '#FECEDC', name: 'Ê°ú' },
            { id: 'matcha', color: '#96B1A0', name: 'ÊäπËå∂' }, { id: 'ai', color: '#264D70', name: 'Ëóç' },
            { id: 'yamabuki', color: '#FCA500', name: 'Â±±Âêπ' }, { id: 'fuji', color: '#A290C4', name: 'Ëó§' },
            { id: 'akane', color: '#B22C46', name: 'Ëåú' }, { id: 'wakatake', color: '#7BC5A3', name: 'Ëã•Á´π' },
            { id: 'kin', color: '#D4AF37', name: 'Èáë' }, { id: 'gin', color: '#C0C0C0', name: 'ÈäÄ' },
        ];
        
        const CURRENCIES = [
            { code: 'CNY', name: '‰∫∫Ê∞ëÂ∏Å', flag: 'üá®üá≥' }, { code: 'USD', name: 'ÁæéÂÖÉ', flag: 'üá∫üá∏' }, { code: 'EUR', name: 'Ê¨ßÂÖÉ', flag: 'üá™üá∫' },
            { code: 'JPY', name: 'Êó•ÂÖÉ', flag: 'üáØüáµ' }, { code: 'GBP', name: 'Ëã±Èïë', flag: 'üá¨üáß' }, { code: 'AUD', name: 'Êæ≥ÂÖÉ', flag: 'üá¶üá∫' },
            { code: 'CAD', name: 'Âä†ÂÖÉ', flag: 'üá®üá¶' }, { code: 'CHF', name: 'ÁëûÂ£´Ê≥ïÈÉé', flag: 'üá®üá≠' }, { code: 'HKD', name: 'Ê∏ØÂ∏Å', flag: 'üá≠üá∞' },
        ];
        
        const i18n = {
            zh: {
                headerTitle: 'Êô∫ËÉΩÁßëÂ≠¶ËÆ°ÁÆóÂô®', aiBtnTitle: 'AI ÂäüËÉΩ', settingsBtnTitle: 'ËÆæÁΩÆ', historyBtnTitle: 'ÂéÜÂè≤ËÆ∞ÂΩï',
                sinLabel: 'Ê≠£Âº¶', cosLabel: '‰ΩôÂº¶', tanLabel: 'Ê≠£Âàá', logLabel: 'ÂØπÊï∞', lnLabel: 'Ëá™ÁÑ∂ÂØπÊï∞', powerLabel: '‰πòÊñπ', sqrtLabel: 'Âπ≥ÊñπÊ†π', factLabel: 'Èò∂‰πò', piLabel: 'ÂúÜÂë®Áéá', eLabel: 'Ëá™ÁÑ∂Â∏∏Êï∞',
                solveSteps: 'Ëß£È¢òÊÄùË∑Ø',
                settingsTitle: 'ËÆæÁΩÆ', themeTitle: 'ÈÄâÊã©‰∏ªÈ¢ò', languageTitle: 'ÈÄâÊã©ËØ≠Ë®Ä',
                historyTitle: 'ÂéÜÂè≤ËÆ∞ÂΩï', clearHistory: 'Ê∏ÖÁ©∫ÂéÜÂè≤', noHistory: 'ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï',
                aiTitle: 'AI Êô∫ËÉΩÂäüËÉΩ', wordProblem: 'ÊñáÂ≠óÈóÆÈ¢òÊ±ÇËß£', summarizeHistory: 'ÊÄªÁªìÂéÜÂè≤', explainFormula: 'ÂÖ¨ÂºèÂ∫îÁî®',
                exchangeRate: 'Ê±áÁéáÊç¢ÁÆó', lifeCalculations: 'ÁîüÊ¥ªËÆ°ÁÆó',
                wordProblemTitle: 'ÊñáÂ≠óÈóÆÈ¢òÊ±ÇËß£', wordProblemPlaceholder: '‰æãÂ¶ÇÔºö‰∏Ä‰∏™ÂïÜÂìÅÂéü‰ª∑500ÂÖÉÔºåÊâìÂÖ´ÊäòÂêéÊòØÂ§öÂ∞ëÈí±Ôºü', solveWordProblem: '‚ú® Êô∫ËÉΩÊ±ÇËß£',
                error: 'ÈîôËØØ', aiLoading: 'AI ÂàÜÊûê‰∏≠...', aiGenerating: 'Ê≠£Âú®ÁîüÊàêÔºåËØ∑Á®çÂÄô...',
                lifeCalculationsTitle: 'ÁîüÊ¥ªËÆ°ÁÆó‰∏≠ÂøÉ', financialTools: 'ÈáëËûçÂä©Êâã', healthWellness: 'ÂÅ•Â∫∑ÁÆ°ÁêÜ', dailyTools: 'Êó•Â∏∏Â∑•ÂÖ∑',
                loanCalc: 'Ë¥∑Ê¨æËÆ°ÁÆó', tipCalc: 'Â∞èË¥πËÆ°ÁÆó', discountCalc: 'ÊäòÊâ£ËÆ°ÁÆó', taxCalc: '‰∏™Á®éËÆ°ÁÆó', 
                bmiCalc: 'BMIÂÅ•Â∫∑ÊåáÊï∞', calorieCalc: 'Âç°Ë∑ØÈáåÊ∂àËÄó',
                fuelCalc: 'Ê≤πËÄóËÆ°ÁÆó', unitConversion: 'Âçï‰ΩçÊç¢ÁÆó', electricityBill: 'ÁîµË¥πËÆ°ÁÆó', powerCalc: 'ÂäüÁéáËÆ°ÁÆó',
                exchangeRateTitle: 'Ê±áÁéáÊç¢ÁÆó', from: '‰ªé', to: 'Âà∞', amount: 'ÈáëÈ¢ù', convert: 'Êç¢ÁÆó', result: 'ÁªìÊûú',
                calculate: 'ËÆ°ÁÆó',
                promptSolveSteps: "ËØ∑Áî®ÁÆÄ‰Ωì‰∏≠ÊñáÔºå‰ª•Ê∏ÖÊô∞„ÄÅÂàÜÊ≠•ÁöÑÊñπÂºèËß£ÈáäÂ¶Ç‰ΩïËÆ°ÁÆó‰ª•‰∏ãÊï∞Â≠¶Ë°®ËææÂºèÔºåÂπ∂ÁªôÂá∫ÊúÄÁªàÁ≠îÊ°à„ÄÇË°®ËææÂºè‰∏∫Ôºö'{expression}'",
                promptSummarize: 'ËØ∑Áî®ÁÆÄ‰Ωì‰∏≠ÊñáÊÄªÁªì‰ª•‰∏ãËÆ°ÁÆóÂéÜÂè≤„ÄÇÂàÜÊûêËÆ°ÁÆóÁöÑÁ±ªÂûãÔºåÂπ∂‰ª•Ê∏ÖÊô∞ÁöÑÂàóË°®ÂΩ¢ÂºèÂëàÁé∞„ÄÇÂéÜÂè≤ËÆ∞ÂΩï‰∏∫Ôºö "{history}"',
                promptExplain: 'ËØ∑Áî®ÁÆÄ‰Ωì‰∏≠ÊñáÔºåÁÆÄÊ¥ÅÂú∞Ëß£Èáä‰∏Ä‰∏ãÊï∞Â≠¶ÂÖ¨Âºè "{expression}" Âú®Áé∞ÂÆû‰∏ñÁïå‰∏≠ÁöÑ‰∏Ä‰∏™ÂÖ∏ÂûãÂ∫îÁî®Âú∫ÊôØ„ÄÇ',
                promptWordProblem: 'ËØ∑‰ªé‰ª•‰∏ã‰∏≠ÊñáÊñáÂ≠óÈóÆÈ¢ò‰∏≠ÔºåÊèêÂèñÂá∫Áî®‰∫éËÆ°ÁÆóÁöÑÊï∞Â≠¶Ë°®ËææÂºè„ÄÇËØ∑Âè™ËøîÂõûË°®ËææÂºèÔºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïÂÖ∂‰ªñÊñáÂ≠óÊàñËß£Èáä„ÄÇ‰æãÂ¶ÇÔºåÂØπ‰∫éÈóÆÈ¢ò‚Äú‰∏Ä‰∏™ÂïÜÂìÅÂéü‰ª∑500ÂÖÉÔºåÊâìÂÖ´ÊäòÂêéÊòØÂ§öÂ∞ëÈí±Ôºü‚ÄùÔºåÂ∫îËøîÂõû‚Äú500 * 0.8‚Äù„ÄÇÈóÆÈ¢òÊòØÔºö‚Äú{problem}‚Äù',
                promptExchangeRate: "Â∞Ü {amount} {from} ËΩ¨Êç¢‰∏∫ {to}„ÄÇËØ∑Âè™Êèê‰æõÊúÄÁªàÁöÑÊï∞Â≠óÁªìÊûúÔºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïË¥ßÂ∏ÅÁ¨¶Âè∑ÊàñÊñáÂ≠ó„ÄÇ",
            },
            en: {
                headerTitle: 'Smart Calculator', aiBtnTitle: 'AI Features', settingsBtnTitle: 'Settings', historyBtnTitle: 'History',
                sinLabel: 'Sine', cosLabel: 'Cosine', tanLabel: 'Tangent', logLabel: 'Log', lnLabel: 'ln', powerLabel: 'Power', sqrtLabel: 'Sqrt', factLabel: 'Factorial', piLabel: 'Pi', eLabel: 'Euler\'s',
                solveSteps: 'Solve Steps',
                settingsTitle: 'Settings', themeTitle: 'Select Theme', languageTitle: 'Select Language',
                historyTitle: 'History', clearHistory: 'Clear History', noHistory: 'No history yet',
                aiTitle: 'AI Smart Features', wordProblem: 'Solve Word Problem', summarizeHistory: 'Summarize History', explainFormula: 'Explain Formula',
                exchangeRate: 'Exchange Rate', lifeCalculations: 'Life Calculations',
                wordProblemTitle: 'Word Problem Solver', wordProblemPlaceholder: 'e.g., A product costs 500, what is the price after a 20% discount?', solveWordProblem: '‚ú® Smart Solve',
                error: 'Error', aiLoading: 'AI Analyzing...', aiGenerating: 'Generating, please wait...',
                lifeCalculationsTitle: 'Life Calculation Center', financialTools: 'Financial Tools', healthWellness: 'Health & Wellness', dailyTools: 'Daily Tools',
                loanCalc: 'Loan Calc', tipCalc: 'Tip Calc', discountCalc: 'Discount Calc', taxCalc: 'Tax Calc', 
                bmiCalc: 'BMI Health', calorieCalc: 'Calorie Burn',
                fuelCalc: 'Fuel Cost', unitConversion: 'Unit Converter', electricityBill: 'Electricity Bill', powerCalc: 'Power Calc',
                exchangeRateTitle: 'Exchange Rate', from: 'From', to: 'To', amount: 'Amount', convert: 'Convert', result: 'Result',
                calculate: 'Calculate',
                promptSolveSteps: "Please explain in English, in a clear, step-by-step manner, how to calculate the following mathematical expression and provide the final answer. The expression is: '{expression}'",
                promptSummarize: 'Please summarize the following calculation history in English. Analyze the types of calculations and present them in a clear list format. The history is: "{history}"',
                promptExplain: 'Please briefly explain in English a typical real-world application scenario for the mathematical formula "{expression}".',
                promptWordProblem: 'From the following English word problem, extract the mathematical expression for calculation. Please return only the expression, without any other text or explanation. For example, for the problem "A product costs 500, what is the price after a 20% discount?", you should return "500 * 0.8". The problem is: "{problem}"',
                promptExchangeRate: "Convert {amount} {from} to {to}. Please provide only the final numerical result, without any currency symbols or text.",
            },
            ja: {
                headerTitle: '„Çπ„Éû„Éº„ÉàÈõªÂçì', aiBtnTitle: 'AIÊ©üËÉΩ', settingsBtnTitle: 'Ë®≠ÂÆö', historyBtnTitle: 'Â±•Ê≠¥',
                sinLabel: 'Ê≠£Âº¶', cosLabel: '‰ΩôÂº¶', tanLabel: 'Ê≠£Êé•', logLabel: 'ÂØæÊï∞', lnLabel: 'Ëá™ÁÑ∂ÂØæÊï∞', powerLabel: '„Åπ„Åç‰πó', sqrtLabel: 'Âπ≥ÊñπÊ†π', factLabel: 'Èöé‰πó', piLabel: 'ÂÜÜÂë®Áéá', eLabel: '„Éç„Ç§„Éî„Ç¢Êï∞',
                solveSteps: 'Ëß£Ê≥ï',
                settingsTitle: 'Ë®≠ÂÆö', themeTitle: '„ÉÜ„Éº„ÉûÈÅ∏Êäû', languageTitle: 'Ë®ÄË™ûÈÅ∏Êäû',
                historyTitle: 'Ë®àÁÆóÂ±•Ê≠¥', clearHistory: 'Â±•Ê≠¥„ÇíÊ∂àÂéª', noHistory: 'Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì',
                aiTitle: 'AI„Çπ„Éû„Éº„ÉàÊ©üËÉΩ', wordProblem: 'ÊñáÁ´†ÂïèÈ°åËß£Ê±∫', summarizeHistory: 'Â±•Ê≠¥„ÅÆË¶ÅÁ¥Ñ', explainFormula: 'Âºè„ÅÆÂøúÁî®',
                exchangeRate: 'ÁÇ∫Êõø„É¨„Éº„Éà', lifeCalculations: 'ÁîüÊ¥ªË®àÁÆó',
                wordProblemTitle: 'ÊñáÁ´†ÂïèÈ°åËß£Ê±∫', wordProblemPlaceholder: '‰æãÔºö„ÅÇ„ÇãÂïÜÂìÅ„ÅÆÂÆö‰æ°„ÅØ500ÂÜÜ„Åß„ÄÅ2Ââ≤Âºï„Å™„Çâ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü', solveWordProblem: '‚ú® „Çπ„Éû„Éº„ÉàËß£Ê±∫',
                error: '„Ç®„É©„Éº', aiLoading: 'AIÂàÜÊûê‰∏≠...', aiGenerating: 'ÁîüÊàê‰∏≠„Åß„Åô„ÄÅ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...',
                lifeCalculationsTitle: 'ÁîüÊ¥ªË®àÁÆó„Çª„É≥„Çø„Éº', financialTools: 'ÈáëËûç„ÉÑ„Éº„É´', healthWellness: 'ÂÅ•Â∫∑ÁÆ°ÁêÜ', dailyTools: 'Êó•Â∏∏„ÉÑ„Éº„É´',
                loanCalc: '„É≠„Éº„É≥Ë®àÁÆó', tipCalc: '„ÉÅ„ÉÉ„ÉóË®àÁÆó', discountCalc: 'Ââ≤ÂºïË®àÁÆó', taxCalc: 'ÊâÄÂæóÁ®éË®àÁÆó', 
                bmiCalc: 'BMIÂÅ•Â∫∑ÊåáÊï∞', calorieCalc: '„Ç´„É≠„É™„ÉºÊ∂àË≤ª',
                fuelCalc: 'ÁáÉË≤ªË®àÁÆó', unitConversion: 'Âçò‰ΩçÂ§âÊèõ', electricityBill: 'ÈõªÊ∞ó‰ª£Ë®àÁÆó', powerCalc: 'ÈõªÂäõË®àÁÆó',
                exchangeRateTitle: 'ÁÇ∫Êõø„É¨„Éº„Éà', from: '„Åã„Çâ', to: '„Å∏', amount: 'ÈáëÈ°ç', convert: 'ÊèõÁÆó', result: 'ÁµêÊûú',
                calculate: 'Ë®àÁÆó',
                promptSolveSteps: "Êó•Êú¨Ë™û„Åß„ÄÅ‰ª•‰∏ã„ÅÆÊï∞Âºè„ÇíË®àÁÆó„Åô„ÇãÊñπÊ≥ï„ÇíÊòéÁ¢∫„Å´„ÄÅ„Çπ„ÉÜ„ÉÉ„Éó„Éê„Ç§„Çπ„ÉÜ„ÉÉ„Éó„ÅßË™¨Êòé„Åó„ÄÅÊúÄÁµÇÁöÑ„Å™Á≠î„Åà„ÇíÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊï∞Âºè„ÅØÊ¨°„ÅÆ„Å®„Åä„Çä„Åß„ÅôÔºö'{expression}'",
                promptSummarize: 'Êó•Êú¨Ë™û„Åß„ÄÅ‰ª•‰∏ã„ÅÆË®àÁÆóÂ±•Ê≠¥„ÇíË¶ÅÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË®àÁÆó„ÅÆÁ®ÆÈ°û„ÇíÂàÜÊûê„Åó„ÄÅÊòéÁ¢∫„Å™„É™„Çπ„ÉàÂΩ¢Âºè„ÅßÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂ±•Ê≠¥„ÅØÊ¨°„ÅÆ„Å®„Åä„Çä„Åß„ÅôÔºö"{history}"',
                promptExplain: 'Êó•Êú¨Ë™û„Åß„ÄÅÊï∞Âºè„Äå{expression}„Äç„ÅÆÁèæÂÆü‰∏ñÁïå„Åß„ÅÆÂÖ∏ÂûãÁöÑ„Å™ÂøúÁî®„Ç∑„Éä„É™„Ç™„ÇíÁ∞°ÊΩî„Å´Ë™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                promptWordProblem: '‰ª•‰∏ã„ÅÆÊó•Êú¨Ë™û„ÅÆÊñáÁ´†ÂïèÈ°å„Åã„Çâ„ÄÅË®àÁÆóÁî®„ÅÆÊï∞Âºè„ÇíÊäΩÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊï∞Âºè„ÅÆ„Åø„ÇíËøî„Åó„ÄÅ‰ªñ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇÑË™¨Êòé„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ‰æã„Åà„Å∞„ÄÅ„Äå„ÅÇ„ÇãÂïÜÂìÅ„ÅÆÂÆö‰æ°„ÅØ500ÂÜÜ„Åß„ÄÅ2Ââ≤Âºï„Å™„Çâ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü„Äç„Å®„ÅÑ„ÅÜÂïèÈ°å„ÅÆÂ†¥Âêà„ÄÅ„Äå500 * 0.8„Äç„ÇíËøî„Åô„Åπ„Åç„Åß„Åô„ÄÇÂïèÈ°å„ÅØÔºö„Äå{problem}„Äç',
                promptExchangeRate: "{amount} {from} „Çí {to} „Å´Â§âÊèõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊúÄÁµÇÁöÑ„Å™Êï∞ÂÄ§ÁµêÊûú„ÅÆ„Åø„ÇíÊèê‰æõ„Åó„ÄÅÈÄöË≤®Ë®òÂè∑„ÇÑ„ÉÜ„Ç≠„Çπ„Éà„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ",
            }
        };

        // --- 2. DOM ÂÖÉÁ¥†Ëé∑Âèñ ---
        const dom = {
            displayInput: document.getElementById('display-input'),
            buttonsGrid: document.querySelector('.buttons-grid'),
            aiBtn: document.getElementById('ai-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            historyBtn: document.getElementById('history-btn'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
        };

        // --- 3. UI Êõ¥Êñ∞‰∏éÊ∏≤Êüì ---
        function updateDisplay() {
            dom.displayInput.textContent = state.expression.replace(/\*/g, '√ó').replace(/\//g, '√∑') || '0';
        }

        function openModal(title, bodyContent) {
            dom.modalTitle.innerHTML = title;
            dom.modalBody.innerHTML = bodyContent;
            dom.modal.classList.add('visible');
        }
        
        function setLanguage(lang) {
            if (!i18n[lang]) return;
            state.currentLanguage = lang;
            const t = i18n[lang];
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (t[key]) el.textContent = t[key];
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                 const key = el.dataset.i18nTitle;
                 if(t[key]) el.title = t[key];
            });
        }

        function renderAiMenu() {
            const t = i18n[state.currentLanguage];
            const menuHtml = `
                <div class="ai-menu">
                    <button class="ai-menu-btn" data-ai-action="exchangeRate">üí± ${t.exchangeRate}</button>
                    <button class="ai-menu-btn" data-ai-action="lifeCalculations">üè† ${t.lifeCalculations}</button>
                    <button class="ai-menu-btn" data-ai-action="wordProblem">‚úçÔ∏è ${t.wordProblem}</button>
                    <button class="ai-menu-btn" data-ai-action="summarize">üìä ${t.summarizeHistory}</button>
                    <button class="ai-menu-btn" data-ai-action="explain">üåç ${t.explainFormula}</button>
                </div>
            `;
            openModal(t.aiTitle, menuHtml);
        }

        function renderHistory() {
            const t = i18n[state.currentLanguage];
            let historyHtml = '<div id="history-modal-body">';
            if (state.history.length === 0) {
                historyHtml += `<p>${t.noHistory}</p>`;
            } else {
                state.history.forEach(item => {
                    historyHtml += `<div class="history-item"><div class="expression">${item.expression.replace(/\*/g, '√ó').replace(/\//g, '√∑')} =</div><div class="result">${item.result}</div></div>`;
                });
            }
            historyHtml += `</div><button id="clear-history-btn" class="primary-btn">${t.clearHistory}</button>`;
            openModal(t.historyTitle, historyHtml);
        }

        function renderWordProblemSolver() {
            const t = i18n[state.currentLanguage];
            const solverHtml = `
                <textarea id="word-problem-textarea" placeholder="${t.wordProblemPlaceholder}"></textarea>
                <button id="solve-word-problem-btn" class="primary-btn">${t.solveWordProblem}</button>
            `;
            openModal(t.wordProblemTitle, solverHtml);
        }
        
        function renderSettingsModal() {
            const t = i18n[state.currentLanguage];
            const settingsHtml = `
                <div class="settings-section">
                    <h4 class="settings-title">${t.themeTitle}</h4>
                    <div id="theme-palette-container">${getThemePaletteHtml()}</div>
                </div>
                <div class="settings-section">
                    <h4 class="settings-title">${t.languageTitle}</h4>
                    <div class="language-options">${getLanguageOptionsHtml()}</div>
                </div>
            `;
            openModal(t.settingsTitle, settingsHtml);
        }

        function getThemePaletteHtml() {
            let paletteHtml = '';
            THEMES.forEach(theme => {
                const isActive = document.documentElement.dataset.theme === theme.id ? 'active' : '';
                paletteHtml += `<div class="theme-item ${isActive}" data-theme-id="${theme.id}"><div class="theme-color-circle" style="background-color: ${theme.color};"></div><span class="theme-name">${theme.name}</span></div>`;
            });
            return paletteHtml;
        }

        function getLanguageOptionsHtml() {
            const languages = [{code: 'zh', name: '‰∏≠Êñá', flag: 'üá®üá≥'}, {code: 'en', name: 'English', flag: 'üá¨üáß'}, {code: 'ja', name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ'}];
            let langHtml = '';
            languages.forEach(lang => {
                const isActive = state.currentLanguage === lang.code ? 'active' : '';
                langHtml += `<button class="lang-btn ${isActive}" data-lang="${lang.code}"><div class="flag">${lang.flag}</div><div class="name">${lang.name}</div></button>`;
            });
            return langHtml;
        }
        
        function renderLifeCalculationsMenu() {
            const t = i18n[state.currentLanguage];
            const menuHtml = `
                <div class="calc-section">
                    <h4 class="calc-title">${t.financialTools}</h4>
                    <div class="life-calc-menu">
                        <button class="life-calc-btn" data-life-calc="loan">üí∞ ${t.loanCalc}</button>
                        <button class="life-calc-btn" data-life-calc="tip">ü™ô ${t.tipCalc}</button>
                        <button class="life-calc-btn" data-life-calc="discount">üõçÔ∏è ${t.discountCalc}</button>
                        <button class="life-calc-btn" data-life-calc="tax">üßæ ${t.taxCalc}</button>
                    </div>
                </div>
                <div class="calc-section">
                    <h4 class="calc-title">${t.healthWellness}</h4>
                    <div class="life-calc-menu">
                        <button class="life-calc-btn" data-life-calc="bmi">‚ù§Ô∏è ${t.bmiCalc}</button>
                        <button class="life-calc-btn" data-life-calc="calorie">üî• ${t.calorieCalc}</button>
                    </div>
                </div>
                <div class="calc-section">
                    <h4 class="calc-title">${t.dailyTools}</h4>
                    <div class="life-calc-menu">
                        <button class="life-calc-btn" data-life-calc="fuel">‚õΩÔ∏è ${t.fuelCalc}</button>
                        <button class="life-calc-btn" data-life-calc="unit">üìè ${t.unitConversion}</button>
                        <button class="life-calc-btn" data-life-calc="electricity">üí° ${t.electricityBill}</button>
                        <button class="life-calc-btn" data-life-calc="power">‚ö°Ô∏è ${t.powerCalc}</button>
                    </div>
                </div>
            `;
            openModal(t.lifeCalculationsTitle, menuHtml);
        }

        function renderExchangeRateConverter() {
            const t = i18n[state.currentLanguage];
            const fromCurrency = CURRENCIES.find(c => c.code === state.exchange.from);
            const toCurrency = CURRENCIES.find(c => c.code === state.exchange.to);
            const converterHtml = `
                <div class="exchange-rate-ui">
                    <div class="currency-selection">
                        <div class="currency-box">
                            <div class="label">${t.from}</div>
                            <button class="currency-button" id="from-currency-btn" data-currency-type="from">
                                <span class="flag">${fromCurrency.flag}</span>
                                <span class="code">${fromCurrency.code}</span>
                            </button>
                        </div>
                        <button id="swap-currency-btn">‚áÜ</button>
                        <div class="currency-box">
                            <div class="label">${t.to}</div>
                            <button class="currency-button" id="to-currency-btn" data-currency-type="to">
                                <span class="flag">${toCurrency.flag}</span>
                                <span class="code">${toCurrency.code}</span>
                            </button>
                        </div>
                    </div>
                    <div id="currency-grid-container" style="display: none;"></div>
                    <div class="form-group">
                        <label for="amount-to-convert">${t.amount}</label>
                        <input type="number" id="amount-to-convert" value="100">
                    </div>
                    <button id="convert-rate-btn" class="primary-btn">${t.convert}</button>
                    <div id="exchange-result-container" class="calc-result" style="display: none;"></div>
                </div>
            `;
            openModal(t.exchangeRateTitle, converterHtml);
        }
        
        function renderCurrencyGrid(type) {
            const t = i18n[state.currentLanguage];
            const gridContainer = document.getElementById('currency-grid-container');
            let gridHtml = `<h4 class="settings-title">${type === 'from' ? t.from : t.to}</h4><div class="currency-grid">`;
            CURRENCIES.forEach(c => {
                gridHtml += `
                    <button class="currency-grid-btn" data-currency-code="${c.code}" data-currency-flag="${c.flag}">
                        <span class="flag">${c.flag}</span>
                        <span class="code">${c.code}</span>
                    </button>
                `;
            });
            gridHtml += '</div>';
            gridContainer.innerHTML = gridHtml;
            gridContainer.style.display = 'block';
        }

        function renderCalculatorUI(type) {
            const t = i18n[state.currentLanguage];
            let title, body;
            const i18n_calc = {
                loan: { title: t.loanCalc, body: `<div class="form-group"><label>Ë¥∑Ê¨æÊÄªÈ¢ù</label><input type="number" id="loan-amount" placeholder="100000"></div><div class="form-group"><label>Âπ¥Âà©Áéá (%)</label><input type="number" id="loan-rate" placeholder="4.9"></div><div class="form-group"><label>Ë¥∑Ê¨æÊúüÈôê (Âπ¥)</label><input type="number" id="loan-years" placeholder="30"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                tip: { title: t.tipCalc, body: `<div class="form-group"><label>Ë¥¶ÂçïÈáëÈ¢ù</label><input type="number" id="bill-amount" placeholder="100"></div><div class="form-group"><label>Â∞èË¥πÊØî‰æã (%)</label><input type="number" id="tip-percent" placeholder="15"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                discount: { title: t.discountCalc, body: `<div class="form-group"><label>Âéü‰ª∑</label><input type="number" id="original-price" placeholder="200"></div><div class="form-group"><label>ÊäòÊâ£ (%)</label><input type="number" id="discount-percent" placeholder="20"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                tax: { title: t.taxCalc, body: `<div class="form-group"><label>ÊúàÊî∂ÂÖ•</label><input type="number" id="income" placeholder="10000"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                bmi: { title: t.bmiCalc, body: `<div class="form-group"><label>Ë∫´È´ò (cm)</label><input type="number" id="height" placeholder="175"></div><div class="form-group"><label>‰ΩìÈáç (kg)</label><input type="number" id="weight" placeholder="70"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                calorie: { title: t.calorieCalc, body: `<div class="form-group"><label>ËøêÂä®Á±ªÂûã</label><select id="activity-type"><option value="3.5">Ê≠•Ë°å</option><option value="7">Ë∑ëÊ≠•</option><option value="8">Ê∏∏Ê≥≥</option><option value="6">È™ëË°å</option></select></div><div class="form-group"><label>‰ΩìÈáç (kg)</label><input type="number" id="calorie-weight" placeholder="70"></div><div class="form-group"><label>Êó∂Èïø (ÂàÜÈíü)</label><input type="number" id="duration" placeholder="30"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                fuel: { title: t.fuelCalc, body: `<div class="form-group"><label>Ë°åÈ©∂ÈáåÁ®ã (km)</label><input type="number" id="distance" placeholder="100"></div><div class="form-group"><label>ÁôæÂÖ¨ÈáåÊ≤πËÄó (L/100km)</label><input type="number" id="fuel-consumption" placeholder="8"></div><div class="form-group"><label>Ê≤π‰ª∑ (ÂÖÉ/L)</label><input type="number" id="fuel-price" placeholder="7.5"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                electricity: { title: t.electricityBill, body: `<div class="form-group"><label>Áî®ÁîµÈáè (kWh)</label><input type="number" id="consumption" placeholder="300"></div><div class="form-group"><label>Áîµ‰ª∑ (ÂÖÉ/Â∫¶)</label><input type="number" id="price" placeholder="0.52"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                power: { title: t.powerCalc, body: `<div class="form-group"><label>ÁîµÂéã (V)</label><input type="number" id="voltage" placeholder="220"></div><div class="form-group"><label>ÁîµÊµÅ (A)</label><input type="number" id="current" placeholder="0.5"></div><button id="calculate-${type}-btn" class="primary-btn">${t.calculate}</button><div id="calc-result-container" class="calc-result" style="display: none;"></div>` },
                unit: { title: t.unitConversion, body: `<div class="life-calc-menu"><button class="life-calc-btn" data-unit-type="length">üìè ${t.length || 'Length'}</button><button class="life-calc-btn" data-unit-type="weight">‚öñÔ∏è ${t.weightUnit || 'Weight'}</button><button class="life-calc-btn" data-unit-type="temperature">üå°Ô∏è ${t.temperature || 'Temperature'}</button></div>` }
            };
            
            if (i18n_calc[type]) {
                openModal(i18n_calc[type].title, i18n_calc[type].body);
            }
        }
        
        function renderUnitConverterUI(unitType) {
            const t = i18n[state.currentLanguage];
            let title, options, defaultFrom, defaultTo;
            const i18n_units = {
                length: { title: t.length, options: { 'm': 'Meter', 'km': 'Kilometer', 'cm': 'Centimeter', 'mm': 'Millimeter', 'mi': 'Mile', 'ft': 'Foot', 'in': 'Inch' }, from: 'm', to: 'ft' },
                weight: { title: t.weightUnit, options: { 'kg': 'Kilogram', 'g': 'Gram', 'lb': 'Pound', 'oz': 'Ounce' }, from: 'kg', to: 'lb' },
                temperature: { title: t.temperature, options: { 'c': 'Celsius', 'f': 'Fahrenheit', 'k': 'Kelvin' }, from: 'c', to: 'f' }
            };
            
            const unitData = i18n_units[unitType];
            if (!unitData) return;

            let optionsHtml = '';
            for(const key in unitData.options) {
                optionsHtml += `<option value="${key}">${unitData.options[key]}</option>`;
            }

            const body = `
                <div class="form-group">
                    <input type="number" id="unit-input" value="1">
                </div>
                <div class="currency-selection" style="margin-bottom: 1rem;">
                    <select id="from-unit" class="form-group">${optionsHtml}</select>
                    <button id="swap-units-btn" class="btn btn-tertiary">‚áÜ</button>
                    <select id="to-unit" class="form-group">${optionsHtml}</select>
                </div>
                <button id="convert-unit-btn" class="primary-btn">${t.convert}</button>
                <div id="calc-result-container" class="calc-result" style="display: none;"></div>
            `;
            openModal(unitData.title, body);
            document.getElementById('from-unit').value = unitData.from;
            document.getElementById('to-unit').value = unitData.to;
        }


        // --- 4. Ê†∏ÂøÉÈÄªËæë ---
        function handleButtonPress(e) {
            const target = e.target.closest('.btn');
            if (!target) return;
            const { value, action, aiAction } = target.dataset;
            if (action) handleAction(action);
            else if (value) handleInput(value);
            else if (aiAction) handleAiAction(aiAction);
        }

        function handleInput(char) {
            if (state.justCalculated && '0123456789.PIE'.includes(char)) {
                state.expression = '';
            }
            state.justCalculated = false;
            if (state.expression === '0' && char !== '.') state.expression = char;
            else state.expression += char;
            updateDisplay();
        }

        function handleAction(action) {
            switch (action) {
                case 'clear': state.expression = ''; state.justCalculated = false; break;
                case 'backspace':
                    if (state.justCalculated) state.expression = '';
                    else state.expression = state.expression.slice(0, -1);
                    state.justCalculated = false;
                    break;
                case 'equals': calculate(); break;
            }
            updateDisplay();
        }

        function calculate() {
            if (!state.expression) return;
            const t = i18n[state.currentLanguage];
            try {
                const evalExpression = state.expression.replace(/PI/g, 'pi').replace(/E/g, 'e');
                const result = math.evaluate(evalExpression);
                const formattedResult = parseFloat(result.toPrecision(12));
                state.history.push({ expression: state.expression, result: formattedResult });
                if (state.history.length > 50) state.history.shift();
                state.expression = String(formattedResult);
                state.justCalculated = true;
                dom.displayInput.classList.add('highlight');
                dom.displayInput.addEventListener('animationend', () => dom.displayInput.classList.remove('highlight'), { once: true });
            } catch (err) {
                state.expression = t.error;
                state.justCalculated = true;
            }
            updateDisplay();
        }

        // --- 5. Gemini API ÂäüËÉΩ ---
        async function callGeminiAPI(prompt) {
            const t = i18n[state.currentLanguage];
            const resultContainer = document.getElementById('exchange-result-container');
            if(resultContainer) {
                 resultContainer.style.display = 'block';
                 resultContainer.innerHTML = `<div class="label">${t.aiGenerating}</div>`;
            } else {
                openModal(t.aiLoading, t.aiGenerating);
            }
            
            try {
                const apiKey = ""; // Provided by environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) throw new Error(`API Request Failed: ${response.status}`);
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) return text;
                else throw new Error("Invalid API response format.");
            } catch (e) {
                return `${t.error}: ${e.message}`;
            }
        }
        
        function formatApiResponse(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br />');
        }

        async function handleAiAction(action) {
            const t = i18n[state.currentLanguage];
            let prompt, title;
            switch (action) {
                case 'exchangeRate': renderExchangeRateConverter(); return;
                case 'lifeCalculations': renderLifeCalculationsMenu(); return;
                case 'solve':
                    if (!state.expression || state.expression === t.error) { openModal(t.error, 'ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÁÆóÂºèÊù•Ëé∑ÂèñËß£È¢òÊÄùË∑Ø„ÄÇ'); return; }
                    title = t.solveSteps;
                    prompt = t.promptSolveSteps.replace('{expression}', state.expression);
                    break;
                case 'summarize':
                    if (state.history.length === 0) { openModal(t.error, 'Ê≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÂèØ‰æõÊÄªÁªì„ÄÇ'); return; }
                    title = t.summarizeHistory;
                    const historyString = state.history.map(item => `${item.expression} = ${item.result}`).join('; ');
                    prompt = t.promptSummarize.replace('{history}', historyString);
                    break;
                case 'explain':
                    if (!state.expression || !isNaN(parseFloat(state.expression))) { openModal(t.error, 'ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÂÖ¨ÂºèÊù•ÂàÜÊûêÂÖ∂Áî®ÈÄî„ÄÇ'); return; }
                    title = t.explainFormula;
                    prompt = t.promptExplain.replace('{expression}', state.expression);
                    break;
                case 'wordProblem':
                    renderWordProblemSolver();
                    return;
                default: return;
            }
            const result = await callGeminiAPI(prompt);
            openModal(title, formatApiResponse(result));
        }

        async function handleWordProblem() {
            const t = i18n[state.currentLanguage];
            const problemText = document.getElementById('word-problem-textarea').value;
            if (!problemText) { openModal(t.error, 'ËØ∑ËæìÂÖ•ÊñáÂ≠óÈóÆÈ¢ò„ÄÇ'); return; }
            const prompt = t.promptWordProblem.replace('{problem}', problemText);
            const expressionResult = await callGeminiAPI(prompt);
            if (expressionResult.startsWith(t.error)) { openModal('AI ÂàÜÊûêÈîôËØØ', expressionResult); } 
            else {
                state.expression = expressionResult.trim();
                calculate();
                dom.modal.classList.remove('visible');
            }
        }
        
        async function handleExchangeRateConversion() {
            const t = i18n[state.currentLanguage];
            const amount = document.getElementById('amount-to-convert').value;
            const resultContainer = document.getElementById('exchange-result-container');

            if (!amount || amount <= 0) {
                resultContainer.style.display = 'block';
                resultContainer.innerHTML = `<div class="value">${t.error}</div><div class="label">Please enter a valid amount.</div>`;
                return;
            }

            const prompt = t.promptExchangeRate.replace('{amount}', amount).replace('{from}', state.exchange.from).replace('{to}', state.exchange.to);
            const result = await callGeminiAPI(prompt);
            
            const convertedValue = parseFloat(result);
            if (!isNaN(convertedValue)) {
                resultContainer.innerHTML = `<div class="label">${amount} ${state.exchange.from} ‚âà</div><div class="value">${convertedValue.toFixed(2)} ${state.exchange.to}</div>`;
            } else {
                resultContainer.innerHTML = `<div class="value">${t.error}</div><div class="label">${result}</div>`;
            }
            resultContainer.style.display = 'block';
        }

        // --- 6. ‰∫ã‰ª∂ÁõëÂê¨Âô® ---
        dom.buttonsGrid.addEventListener('click', handleButtonPress);
        dom.aiBtn.addEventListener('click', renderAiMenu);
        dom.settingsBtn.addEventListener('click', renderSettingsModal);
        dom.historyBtn.addEventListener('click', renderHistory);

        dom.modal.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target && !e.target.closest('.theme-item')) return;
            const el = target || e.target.closest('.theme-item');

            // ÈÄöÁî®ÂÖ≥Èó≠
            if (el.closest('.modal-close-btn')) { dom.modal.classList.remove('visible'); return; }
            
            // AI ËèúÂçï
            if (el.dataset.aiAction) { handleAiAction(el.dataset.aiAction); return; }
            
            // ËÆæÁΩÆ
            if (el.dataset.themeId) {
                document.documentElement.dataset.theme = el.dataset.themeId;
                renderSettingsModal();
                return;
            }
            if (el.dataset.lang) {
                setLanguage(el.dataset.lang);
                renderSettingsModal();
                return;
            }
            
            // ÂéÜÂè≤‰∏éÊñáÂ≠óÈóÆÈ¢ò
            if (el.id === 'clear-history-btn') { state.history = []; renderHistory(); return; }
            if (el.id === 'solve-word-problem-btn') { handleWordProblem(); return; }
            
            // ÁîüÊ¥ªËÆ°ÁÆó
            if (el.dataset.lifeCalc) { renderCalculatorUI(el.dataset.lifeCalc); return; }
            if (el.dataset.unitType) { renderUnitConverterUI(el.dataset.unitType); return; }

            // Ê±áÁéáÊç¢ÁÆó
            if (el.id === 'from-currency-btn' || el.id === 'to-currency-btn') { renderCurrencyGrid(el.dataset.currencyType); return; }
            if (el.dataset.currencyCode) {
                const type = document.querySelector('#currency-grid-container .settings-title').textContent === i18n[state.currentLanguage].from ? 'from' : 'to';
                state.exchange[type] = el.dataset.currencyCode;
                renderExchangeRateConverter();
                return;
            }
            if (el.id === 'swap-currency-btn') {
                [state.exchange.from, state.exchange.to] = [state.exchange.to, state.exchange.from];
                renderExchangeRateConverter();
                return;
            }
            if(el.id === 'convert-rate-btn') { handleExchangeRateConversion(); return; }

            // ÂÖ∑‰ΩìËÆ°ÁÆóÂô®ÈÄªËæë
            const resultContainer = document.getElementById('calc-result-container');
            if (!resultContainer) return;
            
            let resultHtml = '';
            try {
                switch(el.id) {
                    case 'calculate-loan-btn':
                        const amount = parseFloat(document.getElementById('loan-amount').value);
                        const rate = parseFloat(document.getElementById('loan-rate').value) / 100 / 12;
                        const years = parseFloat(document.getElementById('loan-years').value) * 12;
                        if(amount > 0 && rate > 0 && years > 0) {
                            const monthlyPayment = (amount * rate * Math.pow(1 + rate, years)) / (Math.pow(1 + rate, years) - 1);
                            const totalPayment = monthlyPayment * years;
                            resultHtml = `<div class="label">Êúà‰æõ</div><div class="value">${monthlyPayment.toFixed(2)}</div><div class="label" style="margin-top: 0.5rem;">ÊÄªÂà©ÊÅØ</div><div class="value">${(totalPayment - amount).toFixed(2)}</div>`;
                        }
                        break;
                    case 'calculate-tip-btn':
                        const bill = parseFloat(document.getElementById('bill-amount').value);
                        const percent = parseFloat(document.getElementById('tip-percent').value);
                        if(bill > 0 && percent >= 0) {
                             const tip = bill * (percent / 100);
                             const total = bill + tip;
                             resultHtml = `<div class="label">Â∞èË¥π</div><div class="value">${tip.toFixed(2)}</div><div class="label" style="margin-top: 0.5rem;">ÊÄªËÆ°</div><div class="value">${total.toFixed(2)}</div>`;
                        }
                        break;
                    case 'calculate-discount-btn':
                        const price = parseFloat(document.getElementById('original-price').value);
                        const discount = parseFloat(document.getElementById('discount-percent').value);
                        if(price > 0 && discount >= 0) {
                            const saved = price * (discount / 100);
                            const finalPrice = price - saved;
                            resultHtml = `<div class="label">ËäÇÁúÅ</div><div class="value">${saved.toFixed(2)}</div><div class="label" style="margin-top: 0.5rem;">ÊäòÂêé‰ª∑</div><div class="value">${finalPrice.toFixed(2)}</div>`;
                        }
                        break;
                    case 'calculate-tax-btn':
                        const income = parseFloat(document.getElementById('income').value);
                        if(!isNaN(income)) {
                            const tax = Math.max(0, (income - 5000) * 0.03).toFixed(2); // Simplified
                            resultHtml = `<div class="label">Â∫îÁº¥Á®éÊ¨æ</div><div class="value">${tax}</div>`;
                        }
                        break;
                    case 'calculate-bmi-btn':
                        const height = parseFloat(document.getElementById('height').value) / 100;
                        const weight = parseFloat(document.getElementById('weight').value);
                        if(height > 0 && weight > 0) {
                            const bmi = (weight / (height * height)).toFixed(1);
                            resultHtml = `<div class="label">BMIÊåáÊï∞</div><div class="value">${bmi}</div>`;
                        }
                        break;
                    case 'calculate-calorie-btn':
                        const activity = parseFloat(document.getElementById('activity-type').value);
                        const calWeight = parseFloat(document.getElementById('calorie-weight').value);
                        const duration = parseFloat(document.getElementById('duration').value);
                        if(activity > 0 && calWeight > 0 && duration > 0) {
                             const calories = (activity * 3.5 * calWeight / 200 * duration).toFixed(0);
                             resultHtml = `<div class="label">Ê∂àËÄóÁÉ≠Èáè</div><div class="value">${calories} kcal</div>`;
                        }
                        break;
                    case 'calculate-fuel-btn':
                         const distance = parseFloat(document.getElementById('distance').value);
                         const consumption = parseFloat(document.getElementById('fuel-consumption').value);
                         const fuelPrice = parseFloat(document.getElementById('fuel-price').value);
                         if(distance > 0 && consumption > 0 && fuelPrice > 0) {
                             const cost = (distance / 100 * consumption * fuelPrice).toFixed(2);
                             resultHtml = `<div class="label">ÊÄªËä±Ë¥π</div><div class="value">${cost}</div>`;
                         }
                         break;
                    case 'calculate-electricity-btn':
                        const elecConsumption = parseFloat(document.getElementById('consumption').value);
                        const elecPrice = parseFloat(document.getElementById('price').value);
                        if(!isNaN(elecConsumption) && !isNaN(elecPrice)) {
                            resultHtml = `<div class="label">ÊÄªÁîµË¥π</div><div class="value">${(elecConsumption * elecPrice).toFixed(2)}</div>`;
                        }
                        break;
                    case 'calculate-power-btn':
                        const voltage = parseFloat(document.getElementById('voltage').value);
                        const current = parseFloat(document.getElementById('current').value);
                        if(!isNaN(voltage) && !isNaN(current)) {
                            resultHtml = `<div class="label">ÂäüÁéá</div><div class="value">${(voltage * current).toFixed(2)} W</div>`;
                        }
                        break;
                    case 'convert-unit-btn':
                         const input = parseFloat(document.getElementById('unit-input').value);
                         const from = document.getElementById('from-unit').value;
                         const to = document.getElementById('to-unit').value;
                         if(!isNaN(input)) {
                             const result = math.unit(input, from).to(to).toNumber().toFixed(3);
                             resultHtml = `<div class="value">${result} ${to}</div>`;
                         }
                         break;
                    case 'swap-units-btn':
                        const fromSelect = document.getElementById('from-unit');
                        const toSelect = document.getElementById('to-unit');
                        [fromSelect.value, toSelect.value] = [toSelect.value, fromSelect.value];
                        return;
                }
                if (resultHtml) {
                    resultContainer.innerHTML = resultHtml;
                    resultContainer.style.display = 'block';
                }
            } catch(err) {
                resultContainer.innerHTML = `<div class="value">${i18n[state.currentLanguage].error}</div>`;
                resultContainer.style.display = 'block';
            }
        });

        // --- 7. ÂàùÂßãÂåñ ---
        updateDisplay();
        setLanguage('zh');
    </script>
</body>
</html>
